<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Hunt Home</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .panel { background: white; border-radius: 10px; padding: 20px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .hidden { display: none; }
        .muted { color: #666; }
        .meta { font-size: 13px; color: #555; margin: 6px 0; }
        textarea { width: 100%; min-height: 110px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .row { display: flex; gap: 10px; }
        .row > * { flex: 1; }
        .status { margin-top: 10px; font-weight: 600; }
        .status.ok { color: #166534; }
        .status.err { color: #b91c1c; }
        .job-actions { margin-top: 10px; }
        .application-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin: 10px 0; background: #fafafa; }
        .action-link { display: inline-block; margin-left: 8px; font-size: 14px; }
        .status-badge { display: inline-block; padding: 2px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; }
        .status-badge.pending { background: #fef3c7; color: #92400e; }
        .status-badge.shortlisted { background: #e0f2fe; color: #075985; }
        .status-badge.approved { background: #dcfce7; color: #166534; }
        .status-badge.rejected { background: #fee2e2; color: #991b1b; }
        .application-actions { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
        .application-actions button { padding: 7px 10px; font-size: 13px; }
        .application-actions button:disabled { opacity: 0.65; cursor: not-allowed; }
        .seeker-top-nav { display: flex; gap: 8px; }
        .seeker-top-nav button { background: #059669; font-size: 13px; padding: 8px 12px; }
        .seeker-top-nav.hidden { display: none; }
        .application-card.seek-view { background: #fff; }
        .dashboard-stats { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; margin: 10px 0; }
        .stat-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px 12px; }
        .stat-card .label { font-size: 12px; color: #64748b; }
        .stat-card .value { font-size: 22px; font-weight: 700; color: #0f172a; margin-top: 4px; }
        .dashboard-actions { margin: 8px 0 14px; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; background: #fff; }
        .dashboard-actions ul { margin: 8px 0 0 16px; padding: 0; }
        .email-modal-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.45); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .email-modal-backdrop.hidden { display: none; }
        .email-modal { width: min(720px, 92vw); background: #fff; border-radius: 12px; box-shadow: 0 14px 40px rgba(0, 0, 0, 0.25); padding: 16px; }
        .email-modal h3 { margin: 0 0 8px; }
        .email-modal .actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 10px; }
        .email-modal .actions button { min-width: 90px; }
        .welcome-animated {
            display: inline-block;
            animation: welcomeFloat 5s ease-in-out infinite;
        }
        @keyframes welcomeFloat {
            0% { transform: translateY(0); opacity: 0.92; }
            50% { transform: translateY(-4px); opacity: 1; }
            100% { transform: translateY(0); opacity: 0.92; }
        }
        .filters-wrap { margin-top: 10px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f8fafc; }
        .filter-grid { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
        .filter-grid label { display: flex; align-items: center; gap: 6px; font-size: 13px; color: #334155; }
        .landing-hero {
            margin-top: 18px;
            border-radius: 14px;
            padding: 24px;
            color: #fff;
            background:
                linear-gradient(120deg, rgba(15, 23, 42, 0.85), rgba(30, 64, 175, 0.78)),
                url("https://images.unsplash.com/photo-1522075469751-3a6694fb2f61?auto=format&fit=crop&w=1200&q=80") center/cover no-repeat;
        }
        .landing-hero h2 { color: #fff; margin: 0 0 10px; font-size: 30px; }
        .landing-hero p { margin: 0; max-width: 760px; line-height: 1.55; }
        .landing-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 14px;
            margin-top: 16px;
        }
        .welcome-ticker {
            grid-column: 1 / -1;
            overflow: hidden;
            border: 1px solid #dbeafe;
            background: #eff6ff;
            border-radius: 10px;
            padding: 8px 0;
        }
        .welcome-ticker-text {
            margin: 0;
            white-space: nowrap;
            color: #1e3a8a;
            font-weight: 600;
            padding-left: 100%;
            animation: tickerMove 16s linear infinite;
        }
        @keyframes tickerMove {
            0% { transform: translateX(0); }
            100% { transform: translateX(-120%); }
        }
        .landing-card {
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
        }
        .landing-card.clickable { cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .landing-card.clickable:hover { transform: translateY(-4px); box-shadow: 0 10px 24px rgba(15, 23, 42, 0.14); }
        .landing-card img {
            display: block;
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        .landing-card .content {
            padding: 12px 14px 14px;
        }
        .landing-card h4 {
            margin: 0 0 6px;
            color: #0f172a;
            font-size: 16px;
        }
        .landing-card p {
            margin: 0;
            color: #475569;
            font-size: 13px;
            line-height: 1.45;
        }
        @media (max-width: 900px) {
            .landing-grid { grid-template-columns: 1fr; }
            .landing-hero h2 { font-size: 24px; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="navbar">
        <h1>Job Hunt</h1>
        <div class="nav-links">
            <a href="index.html?home=1" class="nav-link">Home</a>
            <div id="seeker-top-nav" class="seeker-top-nav hidden">
                <button type="button" onclick="openMyApplicationsPage()">My Applications</button>
            </div>
            <div id="nav-buttons"></div>
        </div>
    </div>

    <div class="banner">
        <h3>Welcome to Job Hunt</h3>
        <p id="welcome-text" class="welcome-animated">Where Talent Meets Opportunity<br><br>Finding the right job or the right employee shouldn’t be stressful. Our platform is designed to help employers find dependable, hardworking talent while helping job seekers discover meaningful opportunities that match their skills and ambitions.</p>
    </div>

    <div id="guest-panel" class="panel">
        <h2>Access Jobs After Login</h2>
        <p class="muted">Sign up for opportunies and competend personel 
            all in one grid.</p>
        <div id="guest-auth-actions">
            <button onclick="goToLogin()">Login</button>
            <button onclick="goToRegister()" style="background:#fff;color:#4CAF50;border:2px solid #4CAF50;">Register</button>
        </div>
        <div id="guest-loggedin-actions" class="hidden">
            <button type="button" onclick="goToDashboard()">Go to Dashboard</button>
        </div>

        <div class="landing-hero">
            <h2>Build Your Next Career Move</h2>
            <p>Explore quality openings, apply with confidence, and track every application status in one place. Employers can review candidates quickly and keep applicants informed.</p>
        </div>

        <div class="landing-grid">
            <div class="welcome-ticker">
                <p class="welcome-ticker-text">Welcome to Job Hunt, your space to discover opportunities, apply with confidence, and grow your career journey.</p>
            </div>
            <div class="landing-card clickable" onclick="goToLogin()" role="button" tabindex="0">
                <img src="https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?auto=format&fit=crop&w=900&q=80" alt="Job seeker planning career">
                <div class="content">
                    <h4>Smart Job Discovery</h4>
                    <p>Discover opportunities that match your skills and goals.</p>
                </div>
            </div>
            <div class="landing-card clickable" onclick="goToLogin()" role="button" tabindex="0">
                <img src="https://images.unsplash.com/photo-1573497620053-ea5300f94f21?auto=format&fit=crop&w=900&q=80" alt="Employer reviewing candidate applications">
                <div class="content">
                    <h4>Real Hiring Progress</h4>
                    <p>Track application status and get real-time updates on hiring progress.</p>
                </div>
            </div>
            <div class="landing-card clickable" onclick="goToRegister()" role="button" tabindex="0">
                <img src="https://images.unsplash.com/photo-1431540015161-0bf868a2d407?auto=format&fit=crop&w=900&q=80" alt="Team collaboration in office">
                <div class="content">
                    <h4>Faster Employer Workflow</h4>
                    <p>Post jobs, review applicants, and communicate decisions quickly from one dashboard.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="employer-panel" class="panel hidden">
        <h2>Employer Dashboard</h2>
        <p class="muted">Post new openings and manage hiring.</p>

        <h3>Overview</h3>
        <div id="employer-dashboard-stats" class="dashboard-stats"></div>
        <div id="employer-dashboard-actions" class="dashboard-actions"></div>

        <h3>Post a Job</h3>
        <form id="postJobForm">
            <div class="row">
                <input id="job-title" type="text" placeholder="Job title" required>
                <input id="job-company" type="text" placeholder="Company" required>
            </div>
            <div class="row">
                <input id="job-location" type="text" placeholder="Location" required>
                <input id="job-salary" type="text" placeholder="Salary range">
            </div>
            <div class="row">
                <select id="job-employment-type">
                    <option value="entry level">Entry Level</option>
                    <option value="internship">Internship</option>
                    <option value="permanent">Permanent</option>
                </select>
                <input id="job-deadline" type="date" placeholder="Application deadline">
            </div>
            <select id="job-category">
                <option value="Others">Others</option>
                <option value="Manual & Physical Labor">Manual & Physical Labor</option>
                <option value="Service & Hospitality">Service & Hospitality</option>
                <option value="Transportation & Logistics">Transportation & Logistics</option>
                <option value="Administrative & Office Support">Administrative & Office Support</option>
                <option value="Business & Finance">Business & Finance</option>
                <option value="Education & Training">Education & Training</option>
                <option value="Technology & Digital Careers">Technology & Digital Careers</option>
                <option value="Creative & Media">Creative & Media</option>
                <option value="Specialized & Professional Fields">Specialized & Professional Fields</option>
                <option value="Emerging & Modern Gig Economy">Emerging & Modern Gig Economy</option>
            </select>
            <div class="filters-wrap">
                <div class="meta">Quick Tags</div>
                <div class="filter-grid">
                    <label><input id="tag-entry-level" type="checkbox"> Entry Level</label>
                    <label><input id="tag-no-degree" type="checkbox"> No Degree Required</label>
                    <label><input id="tag-remote" type="checkbox"> Remote Jobs</label>
                    <label><input id="tag-part-time" type="checkbox"> Part-Time</label>
                    <label><input id="tag-high-paying" type="checkbox"> High Paying</label>
                    <label><input id="tag-fast-hiring" type="checkbox"> Fast Hiring</label>
                </div>
            </div>
            <input id="job-contact-email" type="email" placeholder="Application contact email (for email option)">
            <textarea id="job-description" placeholder="Job description" required></textarea>
            <textarea id="job-requirements" placeholder="Requirements / qualifications"></textarea>
            <button type="submit">Post Job</button>
        </form>
        <div id="employer-status" class="status"></div>

        <h3>Jobs You Posted</h3>
        <div id="employer-jobs"></div>
        <h3>Review Applications</h3>
        <div class="row">
            <select id="employer-job-filter" onchange="handleEmployerJobTypeFilterChange()">
                <option value="all">All Job Types</option>
                <option value="entry level">Entry Level</option>
                <option value="internship">Internship</option>
                <option value="permanent">Permanent</option>
            </select>
        </div>
        <div id="applications-filter-meta" class="meta"></div>
        <div id="employer-applications"></div>
    </div>

    <div id="seeker-panel" class="panel hidden">
        <h2>Available Jobs</h2>
        <input type="text" id="searchInput" placeholder="Search by title or company" onkeyup="searchJobs()" />
        <div class="row">
            <select id="categoryFilter" onchange="searchJobs()">
                <option value="all">All Categories</option>
                <option value="Manual & Physical Labor">Manual & Physical Labor</option>
                <option value="Service & Hospitality">Service & Hospitality</option>
                <option value="Transportation & Logistics">Transportation & Logistics</option>
                <option value="Administrative & Office Support">Administrative & Office Support</option>
                <option value="Business & Finance">Business & Finance</option>
                <option value="Education & Training">Education & Training</option>
                <option value="Technology & Digital Careers">Technology & Digital Careers</option>
                <option value="Creative & Media">Creative & Media</option>
                <option value="Specialized & Professional Fields">Specialized & Professional Fields</option>
                <option value="Emerging & Modern Gig Economy">Emerging & Modern Gig Economy</option>
                <option value="Others">Others</option>
            </select>
        </div>
        <div class="filters-wrap">
            <div class="meta">Filters</div>
            <div class="filter-grid">
                <label><input id="filter-entry-level" type="checkbox" onchange="searchJobs()"> Entry Level</label>
                <label><input id="filter-no-degree" type="checkbox" onchange="searchJobs()"> No Degree Required</label>
                <label><input id="filter-remote" type="checkbox" onchange="searchJobs()"> Remote Jobs</label>
                <label><input id="filter-part-time" type="checkbox" onchange="searchJobs()"> Part-Time</label>
                <label><input id="filter-high-paying" type="checkbox" onchange="searchJobs()"> High Paying</label>
                <label><input id="filter-fast-hiring" type="checkbox" onchange="searchJobs()"> Fast Hiring</label>
            </div>
        </div>
        <div id="seeker-status" class="status"></div>
        <div id="seeker-jobs"></div>
    </div>

    <div id="apply-panel" class="panel hidden">
        <h2>Apply for Job</h2>
        <p id="apply-job-title" class="meta"></p>
        <form id="applyForm">
            <div class="row">
                <input id="apply-full-name" type="text" placeholder="Full name" required>
                <input id="apply-email" type="email" placeholder="Email address" required>
            </div>
            <input id="apply-phone" type="text" placeholder="Phone number (optional)">
            <textarea id="apply-cover-letter" placeholder="Cover letter (optional)"></textarea>
            <textarea id="qualification-text" placeholder="Write your qualifications and experience" required></textarea>
            <input id="qualification-file" type="file" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg">
            <button type="submit">Submit Application</button>
            <button type="button" onclick="closeApplyPanel()" style="background:#9ca3af;">Cancel</button>
        </form>
        <div id="apply-status" class="status"></div>
    </div>

    <div id="email-modal-backdrop" class="email-modal-backdrop hidden">
        <div class="email-modal">
            <h3>Send Email to Applicant</h3>
            <p id="email-modal-target" class="meta"></p>
            <input id="email-subject" type="text" placeholder="Email subject">
            <textarea id="email-message" placeholder="Write your message"></textarea>
            <div class="actions">
                <button type="button" onclick="closeEmailModal()" style="background:#9ca3af;">Cancel</button>
                <button type="button" onclick="submitEmployerEmail()">Send</button>
            </div>
        </div>
    </div>

    <footer class="site-footer">
        <div class="footer-grid">
            <div>
                <h4 class="footer-title">Job Hunt</h4>
                <p>Helping job seekers find opportunities and helping employers hire faster with clear application tracking.</p>
            </div>
            <div>
                <h4 class="footer-title">Contact</h4>
                <p>Email: natililevy65@gmail.com</p>
                <p>Phone: 0791604923</p>
                <p>Location: Nairobi, Kenya</p>
            </div>
            <div>
                <h4 class="footer-title">Quick Links</h4>
                <ul>
                    <li><a href="index.html?home=1">Home</a></li>
                    <li><a href="login.html">Login / Register</a></li>
                    <li><a href="my-applications.html">My Applications</a></li>
                </ul>
            </div>
            <div>
                <h4 class="footer-title">Follow</h4>
                <p><a href="https://www.facebook.com/share/17w3pXHKeN/" target="_blank" rel="noreferrer">Facebook</a></p>
                <p><a href="https://www.linkedin.com/in/levy-natili-1a239b331?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app" target="_blank" rel="noreferrer">LinkedIn</a></p>
            </div>
        </div>
        <div class="footer-bottom">&copy; 2026 Job Hunt. All rights reserved.</div>
    </footer>
</div>

<script>
let allJobs = [];
let filteredJobs = [];
let appliedJobIds = new Set();
let employerApplications = [];
let selectedEmployerJobId = null;
let selectedEmployerJobType = "all";
let selectedJob = null;
let emailDraft = null;
let currentUser = null;
let apiBase = null;

const apiCandidates = ["", "http://127.0.0.1:5001", "http://localhost:5001", "http://localhost:5000"];
const guestWelcomeText = "Where Talent Meets Opportunity<br><br>Finding the right job or the right employee shouldn’t be stressful. Our platform is designed to help employers find dependable, hardworking talent while helping job seekers discover meaningful opportunities that match their skills and ambitions.";

function goToLogin() {
    localStorage.setItem("authTab", "login");
    window.location.href = "login.html";
}

function goToRegister() {
    localStorage.setItem("authTab", "register");
    window.location.href = "login.html";
}

function logoutUser() {
    localStorage.removeItem("token");
    window.location.href = "index.html?home=1";
}

function goToDashboard() {
    window.location.href = "index.html";
}

function updateNavButtons() {
    const token = localStorage.getItem("token");
    const navButtons = document.getElementById("nav-buttons");

    if (token) {
        navButtons.innerHTML = `
            <button onclick="logoutUser()" style="background-color:#f44336;color:white;">Logout</button>
        `;
    } else {
        navButtons.innerHTML = `
            <button onclick="goToLogin()" style="background-color:#2196F3;color:white;">Login</button>
            <button onclick="goToRegister()" style="background-color:white;color:#4CAF50;border:2px solid white;">Register</button>
        `;
    }
}

async function resolveApiBase() {
    if (apiBase !== null) return apiBase;

    for (const candidate of apiCandidates) {
        try {
            const res = await fetch(`${candidate}/health`);
            if (res.ok) {
                apiBase = candidate;
                return apiBase;
            }
        } catch (err) {
            // continue to next candidate
        }
    }

    apiBase = "";
    return apiBase;
}

async function apiFetch(path, options = {}) {
    const token = localStorage.getItem("token");
    const base = await resolveApiBase();
    const headers = { ...(options.headers || {}) };
    if (token) headers.authorization = token;

    return fetch(`${base}${path}`, { ...options, headers });
}

function toAssetUrl(filePath) {
    if (!filePath) return "";
    if (/^https?:\/\//i.test(filePath)) return filePath;
    return `${apiBase || ""}${filePath}`;
}

function showOnly(panelId) {
    ["guest-panel", "employer-panel", "seeker-panel"].forEach((id) => {
        document.getElementById(id).classList.add("hidden");
    });
    document.getElementById(panelId).classList.remove("hidden");
}

function setGuestHomeActions(loggedIn) {
    const guestAuth = document.getElementById("guest-auth-actions");
    const guestLoggedIn = document.getElementById("guest-loggedin-actions");
    if (!guestAuth || !guestLoggedIn) return;
    guestAuth.classList.toggle("hidden", loggedIn);
    guestLoggedIn.classList.toggle("hidden", !loggedIn);
}

function setEmployerTopNav(visible) {
    return visible;
}

function setSeekerTopNav(visible) {
    const nav = document.getElementById("seeker-top-nav");
    if (!nav) return;
    nav.classList.toggle("hidden", !visible);
}

function scrollToEmployerSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (!section) return;
    section.scrollIntoView({ behavior: "smooth", block: "start" });
}

function openMyApplicationsPage() {
    window.location.href = "my-applications.html";
}

async function loadCurrentUser() {
    const token = localStorage.getItem("token");
    if (!token) return null;

    const res = await apiFetch("/api/auth/profile");
    if (!res.ok) {
        localStorage.removeItem("token");
        return null;
    }
    const data = await res.json();
    return data.user;
}

async function loadJobs() {
    const res = await apiFetch("/api/jobs");
    if (!res.ok) throw new Error(`Failed to load jobs (${res.status})`);
    allJobs = await res.json();
    filteredJobs = [...allJobs];
}

async function loadAppliedJobs() {
    const res = await apiFetch("/api/jobs/applied/me");
    if (!res.ok) return;
    const data = await res.json();
    appliedJobIds = new Set(data.appliedJobIds || []);
}

async function loadEmployerApplications() {
    const res = await apiFetch("/api/jobs/employer/applications");
    if (!res.ok) {
        employerApplications = [];
        return;
    }
    const data = await res.json();
    employerApplications = data.applications || [];
}

function normalizeApplicationStatus(status) {
    if (status === "pending") return "Not Yet Reviewed";
    if (status === "shortlisted") return "Shortlisted";
    if (status === "approved") return "Approved";
    if (status === "rejected") return "Rejected";
    return status || "Not Yet Reviewed";
}

function renderEmployerDashboardSummary() {
    const statsHolder = document.getElementById("employer-dashboard-stats");
    const actionsHolder = document.getElementById("employer-dashboard-actions");
    if (!statsHolder || !actionsHolder || !currentUser) return;

    const mineJobs = allJobs.filter((j) => j.posted_by === currentUser.id);
    const totalApps = employerApplications.length;
    const pending = employerApplications.filter((a) => a.status === "pending");
    const shortlisted = employerApplications.filter((a) => a.status === "shortlisted").length;
    const approved = employerApplications.filter((a) => a.status === "approved").length;
    const rejected = employerApplications.filter((a) => a.status === "rejected").length;

    statsHolder.innerHTML = `
        <div class="stat-card"><div class="label">Jobs Posted</div><div class="value">${mineJobs.length}</div></div>
        <div class="stat-card"><div class="label">Total Applications</div><div class="value">${totalApps}</div></div>
        <div class="stat-card"><div class="label">Needs Review</div><div class="value">${pending.length}</div></div>
        <div class="stat-card"><div class="label">Shortlisted</div><div class="value">${shortlisted}</div></div>
        <div class="stat-card"><div class="label">Approved</div><div class="value">${approved}</div></div>
        <div class="stat-card"><div class="label">Rejected</div><div class="value">${rejected}</div></div>
    `;

    if (!pending.length) {
        actionsHolder.innerHTML = "<strong>Activities Required:</strong><p class='muted'>No pending applications right now.</p>";
        return;
    }

    actionsHolder.innerHTML = `
        <strong>Activities Required:</strong>
        <ul>
            ${pending.slice(0, 5).map((a) => `<li>Review <strong>${a.full_name || "Applicant"}</strong> for <strong>${a.job_title}</strong></li>`).join("")}
        </ul>
    `;
}

function renderEmployerJobs() {
    const holder = document.getElementById("employer-jobs");
    let mine = allJobs.filter((j) => j.posted_by === currentUser.id);
    if (selectedEmployerJobType !== "all") {
        mine = mine.filter((j) => (j.employment_type || "").toLowerCase() === selectedEmployerJobType);
    }
    renderEmployerDashboardSummary();

    if (mine.length === 0) {
        holder.innerHTML = "<p class='muted'>No jobs posted yet.</p>";
        return;
    }

    holder.innerHTML = mine.map((job) => `
        <div class="job">
            <h3>${job.title}</h3>
            <p><strong>Company:</strong> ${job.company}</p>
            <p><strong>Location:</strong> ${job.location}</p>
            <p><strong>Salary:</strong> ${job.salary || "Not specified"}</p>
            <p><strong>Employment Type:</strong> ${job.employment_type || "Not specified"}</p>
            <p><strong>Contact Email:</strong> ${job.contact_email || "Not provided"}</p>
            <p>${job.description}</p>
            <div class="job-actions">
                <button type="button" onclick="viewApplicationsForJob(${job.id})">View Applications</button>
                ${selectedEmployerJobId === job.id ? '<button type="button" onclick="clearApplicationsFilter()" style="background:#9ca3af;">Show All</button>' : ""}
            </div>
        </div>
    `).join("");
}

function viewApplicationsForJob(jobId) {
    selectedEmployerJobId = jobId;
    renderEmployerJobs();
    renderEmployerApplications();
}

function clearApplicationsFilter() {
    selectedEmployerJobId = null;
    renderEmployerJobs();
    renderEmployerApplications();
}

function handleEmployerJobTypeFilterChange() {
    selectedEmployerJobType = document.getElementById("employer-job-filter").value;
    renderEmployerJobs();
    renderEmployerApplications();
}

function renderEmployerApplications() {
    renderEmployerDashboardSummary();
    const filterMeta = document.getElementById("applications-filter-meta");
    const holder = document.getElementById("employer-applications");
    let rows = employerApplications;
    const filters = [];

    if (selectedEmployerJobId !== null) {
        rows = employerApplications.filter((a) => a.job_id === selectedEmployerJobId);
        const selectedJobData = allJobs.find((j) => j.id === selectedEmployerJobId);
        filters.push(selectedJobData ? `Job: <strong>${selectedJobData.title}</strong>` : "Job: selected");
    } else {
        filters.push("Job: all your posted jobs");
    }

    if (selectedEmployerJobType !== "all") {
        rows = rows.filter((a) => {
            const job = allJobs.find((j) => j.id === a.job_id);
            return (job?.employment_type || "").toLowerCase() === selectedEmployerJobType;
        });
        filters.push(`Type: <strong>${selectedEmployerJobType}</strong>`);
    } else {
        filters.push("Type: all");
    }
    filterMeta.innerHTML = `Showing applications for ${filters.join(" | ")}`;

    if (!rows.length) {
        holder.innerHTML = "<p class='muted'>No applications yet.</p>";
        return;
    }

    holder.innerHTML = rows.map((a) => `
        <div class="application-card">
            <p><strong>Job:</strong> ${a.job_title} (${a.company})</p>
            <p><strong>Applicant:</strong> ${a.full_name || "N/A"} (${a.applicant_email || "N/A"})</p>
            <p><strong>Phone:</strong> ${a.phone || "N/A"}</p>
            <p><strong>Status:</strong> <span class="status-badge ${a.status}">${normalizeApplicationStatus(a.status)}</span></p>
            <p><strong>Cover Letter:</strong> ${a.cover_letter || "N/A"}</p>
            <p><strong>Qualifications:</strong> ${a.qualification_text || "N/A"}</p>
            ${a.document_path ? `<a class="action-link" href="${toAssetUrl(a.document_path)}" target="_blank" rel="noreferrer">View Resume</a>` : ""}
            ${a.other_document_path ? `<a class="action-link" href="${toAssetUrl(a.other_document_path)}" target="_blank" rel="noreferrer">View Other Document</a>` : ""}
            <div class="application-actions">
                <button type="button" onclick="updateApplicationStatus(${a.application_id}, 'approved')" ${a.status === "approved" ? "disabled" : ""}>Approve</button>
                <button type="button" onclick="updateApplicationStatus(${a.application_id}, 'shortlisted')" ${a.status === "shortlisted" ? "disabled" : ""} style="background:#0ea5e9;">Shortlist</button>
                <button type="button" onclick="updateApplicationStatus(${a.application_id}, 'pending')" ${a.status === "pending" ? "disabled" : ""} style="background:#d1d5db;color:#111827;">Pending</button>
                <button type="button" onclick="updateApplicationStatus(${a.application_id}, 'rejected')" ${a.status === "rejected" ? "disabled" : ""} style="background:#ef4444;">Reject</button>
                ${["approved", "shortlisted"].includes(a.status) ? `<button type="button" onclick="openEmailModal(${a.application_id}, '${a.status}', '${(a.full_name || "Applicant").replace(/'/g, "\\'")}', '${(a.applicant_email || "").replace(/'/g, "\\'")}')">Send Mail</button>` : ""}
            </div>
        </div>
    `).join("");
}

async function updateApplicationStatus(applicationId, statusValue) {
    const status = document.getElementById("employer-status");
    status.textContent = "Updating application status...";
    status.className = "status";

    try {
        const res = await apiFetch(`/api/jobs/employer/applications/${applicationId}/status`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: statusValue })
        });
        const body = await res.json();
        if (!res.ok) throw new Error(body.message || "Failed to update application status");

        status.textContent = `Application marked as ${statusValue}.`;
        status.className = "status ok";
        await loadEmployerApplications();
        renderEmployerApplications();
    } catch (err) {
        status.textContent = err.message;
        status.className = "status err";
    }
}

function openEmailModal(applicationId, currentStatus, applicantName, applicantEmail) {
    emailDraft = { applicationId, currentStatus, applicantName, applicantEmail };
    const defaultSubject = currentStatus === "approved"
        ? "Application Approved - Next Steps"
        : "Application Shortlisted - Next Steps";
    const defaultMessage = currentStatus === "approved"
        ? `Hello ${applicantName}, your application has been approved. Please reply with your availability for the next interview step.`
        : `Hello ${applicantName}, your application has been shortlisted. Please reply with your availability for the next interview step.`;
    document.getElementById("email-subject").value = defaultSubject;
    document.getElementById("email-message").value = defaultMessage;
    document.getElementById("email-modal-target").textContent = `To: ${applicantName} (${applicantEmail || "No email"})`;
    document.getElementById("email-modal-backdrop").classList.remove("hidden");
}

function closeEmailModal() {
    emailDraft = null;
    document.getElementById("email-modal-backdrop").classList.add("hidden");
}

async function submitEmployerEmail() {
    const status = document.getElementById("employer-status");
    if (!emailDraft) return;
    const subjectInput = document.getElementById("email-subject").value.trim();
    const messageInput = document.getElementById("email-message").value.trim();
    if (!messageInput) {
        status.textContent = "Email message cannot be empty.";
        status.className = "status err";
        return;
    }
    status.textContent = "Sending email...";
    status.className = "status";

    try {
        const res = await apiFetch(`/api/jobs/employer/applications/${emailDraft.applicationId}/email`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                subject: subjectInput,
                message: messageInput
            })
        });
        const body = await res.json();
        if (!res.ok) throw new Error(body.message || "Failed to send email");

        status.textContent = "Email sent successfully.";
        status.className = "status ok";
        closeEmailModal();
    } catch (err) {
        status.textContent = err.message;
        status.className = "status err";
    }
}

function renderSeekerJobs() {
    const holder = document.getElementById("seeker-jobs");

    if (filteredJobs.length === 0) {
        holder.innerHTML = "<p class='muted'>No jobs found.</p>";
        return;
    }

    holder.innerHTML = filteredJobs.map((job) => {
        const applied = appliedJobIds.has(job.id);
        return `
            <div class="job">
                <h3>${job.title}</h3>
                <p><strong>Company:</strong> ${job.company}</p>
                <p><strong>Category:</strong> ${job.category || "Others"}</p>
                <p><strong>Location:</strong> ${job.location}</p>
                <p><strong>Salary:</strong> ${job.salary || "Not specified"}</p>
                <p>${job.description}</p>
                <p class="meta"><strong>Requirements:</strong> ${job.requirements || "Not specified"}</p>
                <p class="meta"><strong>Tags:</strong> ${[
                    job.entry_level ? "Entry Level" : "",
                    job.no_degree_required ? "No Degree Required" : "",
                    job.remote_job ? "Remote Jobs" : "",
                    job.part_time ? "Part-Time" : "",
                    job.high_paying ? "High Paying" : "",
                    job.fast_hiring ? "Fast Hiring" : ""
                ].filter(Boolean).join(", ") || "None"}</p>
                <div class="job-actions">
                    <button ${applied ? "disabled" : ""} onclick="openApplyPanel(${job.id})">${applied ? "Applied" : "Apply"}</button>
                    ${job.contact_email ? `<a class="action-link" href="mailto:${job.contact_email}?subject=${encodeURIComponent(`Application for ${job.title}`)}">Apply via Email</a>` : ""}
                </div>
            </div>
        `;
    }).join("");
}

function searchJobs() {
    const value = document.getElementById("searchInput").value.toLowerCase();
    const category = document.getElementById("categoryFilter").value;
    const filters = {
        entryLevel: document.getElementById("filter-entry-level").checked,
        noDegreeRequired: document.getElementById("filter-no-degree").checked,
        remoteJobs: document.getElementById("filter-remote").checked,
        partTime: document.getElementById("filter-part-time").checked,
        highPaying: document.getElementById("filter-high-paying").checked,
        fastHiring: document.getElementById("filter-fast-hiring").checked
    };

    filteredJobs = allJobs.filter((job) =>
        ((job.title || "").toLowerCase().includes(value) ||
            (job.company || "").toLowerCase().includes(value)) &&
        (category === "all" || (job.category || "Others") === category) &&
        (!filters.entryLevel || Boolean(job.entry_level)) &&
        (!filters.noDegreeRequired || Boolean(job.no_degree_required)) &&
        (!filters.remoteJobs || Boolean(job.remote_job)) &&
        (!filters.partTime || Boolean(job.part_time)) &&
        (!filters.highPaying || Boolean(job.high_paying)) &&
        (!filters.fastHiring || Boolean(job.fast_hiring))
    );
    renderSeekerJobs();
}

function openApplyPanel(jobId) {
    window.location.href = `apply.html?jobId=${encodeURIComponent(jobId)}`;
}

function closeApplyPanel() {
    document.getElementById("apply-panel").classList.add("hidden");
    selectedJob = null;
}

function fileToDataUrl(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

async function handlePostJob(event) {
    event.preventDefault();
    const status = document.getElementById("employer-status");
    status.textContent = "Posting job...";
    status.className = "status";

    const payload = {
        title: document.getElementById("job-title").value.trim(),
        company: document.getElementById("job-company").value.trim(),
        location: document.getElementById("job-location").value.trim(),
        salary: document.getElementById("job-salary").value.trim(),
        description: document.getElementById("job-description").value.trim(),
        requirements: document.getElementById("job-requirements").value.trim(),
        employmentType: document.getElementById("job-employment-type").value.trim(),
        applicationDeadline: document.getElementById("job-deadline").value,
        contactEmail: document.getElementById("job-contact-email").value.trim(),
        category: document.getElementById("job-category").value || "Others",
        tags: {
            entryLevel: document.getElementById("tag-entry-level").checked,
            noDegreeRequired: document.getElementById("tag-no-degree").checked,
            remoteJobs: document.getElementById("tag-remote").checked,
            partTime: document.getElementById("tag-part-time").checked,
            highPaying: document.getElementById("tag-high-paying").checked,
            fastHiring: document.getElementById("tag-fast-hiring").checked
        }
    };

    try {
        const res = await apiFetch("/api/jobs", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "Failed to post job");

        status.textContent = "Job posted successfully.";
        status.className = "status ok";
        document.getElementById("postJobForm").reset();

        await loadJobs();
        renderEmployerJobs();
        await loadEmployerApplications();
        renderEmployerApplications();
    } catch (err) {
        status.textContent = err.message;
        status.className = "status err";
    }
}

async function handleApply(event) {
    event.preventDefault();
    if (!selectedJob) return;

    const status = document.getElementById("apply-status");
    status.textContent = "Submitting application...";
    status.className = "status";

    const fullName = document.getElementById("apply-full-name").value.trim();
    const applicantEmail = document.getElementById("apply-email").value.trim();
    const phone = document.getElementById("apply-phone").value.trim();
    const coverLetter = document.getElementById("apply-cover-letter").value.trim();
    const text = document.getElementById("qualification-text").value.trim();
    const file = document.getElementById("qualification-file").files[0];

    if (!fullName || !applicantEmail || !text) {
        status.textContent = "Full name, email, and qualification details are required.";
        status.className = "status err";
        return;
    }

    try {
        let dataUrl = null;
        let documentName = null;
        if (file) {
            dataUrl = await fileToDataUrl(file);
            documentName = file.name;
        }
        const res = await apiFetch(`/api/jobs/${selectedJob.id}/apply`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                fullName,
                applicantEmail,
                phone,
                coverLetter,
                qualificationText: text,
                documentName,
                documentData: dataUrl
            })
        });

        const body = await res.json();
        if (!res.ok) throw new Error(body.message || "Failed to submit application");

        appliedJobIds.add(selectedJob.id);
        renderSeekerJobs();
        status.textContent = "Application submitted successfully.";
        status.className = "status ok";
        closeApplyPanel();
    } catch (err) {
        status.textContent = err.message;
        status.className = "status err";
    }
}

async function init() {
    updateNavButtons();
    const forceHome = new URLSearchParams(window.location.search).get("home") === "1";

    try {
        currentUser = await loadCurrentUser();

        if (!currentUser) {
            setEmployerTopNav(false);
            setSeekerTopNav(false);
            setGuestHomeActions(false);
            showOnly("guest-panel");
            document.getElementById("welcome-text").innerHTML = guestWelcomeText;
            return;
        }

        if (forceHome) {
            setEmployerTopNav(false);
            setSeekerTopNav(false);
            setGuestHomeActions(true);
            showOnly("guest-panel");
            document.getElementById("welcome-text").textContent = `Welcome ${currentUser.name}. You are on the home page.`;
            return;
        }

        await loadJobs();

        if (currentUser.role === "employer") {
            setEmployerTopNav(true);
            setSeekerTopNav(false);
            setGuestHomeActions(false);
            showOnly("employer-panel");
            document.getElementById("welcome-text").textContent = `Welcome ${currentUser.name}. You can post jobs for seekers to apply.`;
            renderEmployerJobs();
            await loadEmployerApplications();
            renderEmployerApplications();
        } else {
            setEmployerTopNav(false);
            setSeekerTopNav(true);
            setGuestHomeActions(false);
            showOnly("seeker-panel");
            document.getElementById("welcome-text").textContent = `Welcome ${currentUser.name}. Browse available jobs and apply.`;
            await loadAppliedJobs();
            renderSeekerJobs();
        }
    } catch (err) {
        setEmployerTopNav(false);
        setSeekerTopNav(false);
        setGuestHomeActions(false);
        showOnly("guest-panel");
        document.getElementById("welcome-text").textContent = `Unable to load data: ${err.message}`;
    }
}

document.getElementById("postJobForm").addEventListener("submit", handlePostJob);
document.getElementById("applyForm").addEventListener("submit", handleApply);

init();
</script>
</body>
</html>
