<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply - Job Hunt</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .panel { background: white; border-radius: 10px; padding: 20px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .muted { color: #666; }
        .meta { font-size: 13px; color: #555; margin: 6px 0; }
        .status { margin-top: 10px; font-weight: 600; }
        .status.ok { color: #166534; }
        .status.err { color: #b91c1c; }
        .row { display: flex; gap: 10px; }
        .row > * { flex: 1; }
        textarea { width: 100%; min-height: 110px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        form { width: 100%; max-width: 100%; box-shadow: none; padding: 0; }
        select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; background: #fff; }
    </style>
</head>
<body>
<div class="container">
    <div class="navbar">
        <h1>Job Hunt</h1>
        <div class="nav-links">
            <a href="index.html?home=1" class="nav-link">Home</a>
        </div>
    </div>

    <div class="banner">
        <h3>Job Application</h3>
        <p id="apply-job-title">Loading selected job...</p>
    </div>

    <div class="panel">
        <h2>Application Details</h2>
        <p class="muted">Fill in your details to submit your application.</p>
        <form id="applyFormPage">
            <div class="row">
                <input id="apply-full-name" type="text" placeholder="Full name" required>
                <input id="apply-email" type="email" placeholder="Email address" required>
            </div>
            <div class="row">
                <input id="apply-phone" type="text" placeholder="Phone number" required>
                <input id="apply-region" type="text" placeholder="Region" required>
            </div>
            <div class="row">
                <input id="apply-location" type="text" placeholder="Current location" required>
                <select id="apply-availability" required>
                    <option value="">Availability</option>
                    <option value="Immediately">Immediately</option>
                    <option value="After 1 month">After 1 month</option>
                    <option value="After 3 months">After 3 months</option>
                </select>
            </div>
            <div class="row">
                <select id="apply-experience" required>
                    <option value="">Experience Level</option>
                    <option value="No experience">No experience</option>
                    <option value="Less than 1 year">Less than 1 year</option>
                    <option value="1-2 years">1-2 years</option>
                    <option value="3-5 years">3-5 years</option>
                    <option value="More than 5 years">More than 5 years</option>
                </select>
                <select id="apply-education" required>
                    <option value="">Education Level</option>
                    <option value="No Formal Education">No Formal Education</option>
                    <option value="Primary / Elementary School">Primary / Elementary School</option>
                    <option value="Some High School">Some High School</option>
                    <option value="High School Diploma / GED">High School Diploma / GED</option>
                    <option value="Vocational / Trade School">Vocational / Trade School</option>
                    <option value="Certificate Program">Certificate Program</option>
                    <option value="Associate Degree">Associate Degree</option>
                    <option value="Bachelor’s Degree">Bachelor’s Degree</option>
                    <option value="Postgraduate Certificate / Diploma">Postgraduate Certificate / Diploma</option>
                    <option value="Master’s Degree">Master’s Degree</option>
                    <option value="Doctorate (PhD / DBA / EdD, etc.)">Doctorate (PhD / DBA / EdD, etc.)</option>
                    <option value="Professional Degree (MD, JD, etc.)">Professional Degree (MD, JD, etc.)</option>
                    <option value="Currently Studying">Currently Studying</option>
                    <option value="Bootcamp / Technical Training">Bootcamp / Technical Training</option>
                    <option value="Online Certification (Coursera, Udemy, etc.)">Online Certification (Coursera, Udemy, etc.)</option>
                    <option value="Self-Taught / Skills-Based Training">Self-Taught / Skills-Based Training</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <input id="apply-field-of-study" type="text" placeholder="Field of Study / Major / Course (optional)">
            <textarea id="apply-notes" placeholder="Additional notes (optional)"></textarea>
            <input id="resume-file" type="file" accept=".pdf,.doc,.docx" />
            <input id="supporting-file" type="file" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg" />
            <button type="submit">Submit Application</button>
            <button type="button" onclick="window.location.href='index.html'" style="background:#9ca3af;">Back to Jobs</button>
        </form>
        <div id="apply-status" class="status"></div>
        <p id="job-meta" class="meta"></p>
    </div>

    <footer class="site-footer">
        <div class="footer-grid">
            <div>
                <h4 class="footer-title">Job Hunt</h4>
                <p>Submit strong applications and track status updates in one place.</p>
            </div>
            <div>
                <h4 class="footer-title">Contact</h4>
                <p>Email: natililevy65@gmail.com</p>
                <p>Phone: 0791604923</p>
            </div>
            <div>
                <h4 class="footer-title">Quick Links</h4>
                <ul>
                    <li><a href="index.html?home=1">Home</a></li>
                    <li><a href="my-applications.html">My Applications</a></li>
                </ul>
            </div>
            <div>
                <h4 class="footer-title">Follow</h4>
                <p><a href="https://www.facebook.com/share/17w3pXHKeN/" target="_blank" rel="noreferrer">Facebook</a></p>
                <p><a href="https://www.linkedin.com/in/levy-natili-1a239b331?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app" target="_blank" rel="noreferrer">LinkedIn</a></p>
            </div>
        </div>
        <div class="footer-bottom">&copy; 2026 Job Hunt. All rights reserved.</div>
    </footer>
</div>

<script>
let currentUser = null;
let selectedJob = null;
let apiBase = null;

const apiCandidates = ["", "http://127.0.0.1:5001", "http://localhost:5001", "http://localhost:5000"];

function parseJobId() {
    const params = new URLSearchParams(window.location.search);
    const id = Number(params.get("jobId"));
    return Number.isInteger(id) && id > 0 ? id : null;
}

async function resolveApiBase() {
    if (apiBase !== null) return apiBase;

    for (const candidate of apiCandidates) {
        try {
            const res = await fetch(`${candidate}/health`);
            if (res.ok) {
                apiBase = candidate;
                return apiBase;
            }
        } catch (err) {
            // Continue
        }
    }

    apiBase = "";
    return apiBase;
}

async function apiFetch(path, options = {}) {
    const token = localStorage.getItem("token");
    const base = await resolveApiBase();
    const headers = { ...(options.headers || {}) };
    if (token) headers.authorization = token;

    return fetch(`${base}${path}`, { ...options, headers });
}

function fileToDataUrl(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

async function loadCurrentUser() {
    const token = localStorage.getItem("token");
    if (!token) return null;
    const res = await apiFetch("/api/auth/profile");
    if (!res.ok) return null;
    const data = await res.json();
    return data.user || null;
}

async function loadSelectedJob(jobId) {
    const res = await apiFetch("/api/jobs");
    if (!res.ok) throw new Error("Failed to load jobs");
    const jobs = await res.json();
    return jobs.find((job) => job.id === jobId) || null;
}

async function handleSubmit(event) {
    event.preventDefault();
    const status = document.getElementById("apply-status");

    if (!selectedJob) {
        status.textContent = "No job selected.";
        status.className = "status err";
        return;
    }

    const fullName = document.getElementById("apply-full-name").value.trim();
    const applicantEmail = document.getElementById("apply-email").value.trim();
    const phone = document.getElementById("apply-phone").value.trim();
    const region = document.getElementById("apply-region").value.trim();
    const location = document.getElementById("apply-location").value.trim();
    const availability = document.getElementById("apply-availability").value.trim();
    const experience = document.getElementById("apply-experience").value.trim();
    const education = document.getElementById("apply-education").value.trim();
    const notes = document.getElementById("apply-notes").value.trim();
    const fieldOfStudy = document.getElementById("apply-field-of-study").value.trim();
    const resumeFile = document.getElementById("resume-file").files[0];
    const supportingFile = document.getElementById("supporting-file").files[0];

    if (!fullName || !applicantEmail || !phone || !region || !location || !availability || !experience || !education) {
        status.textContent = "Please fill all required fields.";
        status.className = "status err";
        return;
    }

    status.textContent = "Submitting application...";
    status.className = "status";

    try {
        let resumeDocumentData = null;
        let resumeDocumentName = null;
        let otherDocumentData = null;
        let otherDocumentName = null;
        if (resumeFile) {
            resumeDocumentData = await fileToDataUrl(resumeFile);
            resumeDocumentName = resumeFile.name;
        }
        if (supportingFile) {
            otherDocumentData = await fileToDataUrl(supportingFile);
            otherDocumentName = supportingFile.name;
        }

        const qualificationText = [
            `Experience: ${experience}`,
            `Education: ${education}`,
            `Field of Study: ${fieldOfStudy || "Not specified"}`,
            `Region: ${region}`,
            `Location: ${location}`,
            `Availability: ${availability}`
        ].join("\n");

        const res = await apiFetch(`/api/jobs/${selectedJob.id}/apply`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                fullName,
                applicantEmail,
                phone,
                coverLetter: notes || null,
                qualificationText,
                resumeDocumentName,
                resumeDocumentData,
                otherDocumentName,
                otherDocumentData
            })
        });
        const body = await res.json();
        if (!res.ok) throw new Error(body.message || "Failed to submit application");

        status.textContent = "Application submitted successfully. Redirecting to My Applications...";
        status.className = "status ok";
        setTimeout(() => {
            window.location.href = "my-applications.html";
        }, 1400);
    } catch (err) {
        status.textContent = err.message;
        status.className = "status err";
    }
}

async function init() {
    const jobId = parseJobId();
    const status = document.getElementById("apply-status");

    if (!jobId) {
        status.textContent = "Invalid job selected.";
        status.className = "status err";
        return;
    }

    currentUser = await loadCurrentUser();
    if (!currentUser) {
        status.textContent = "Please login before applying.";
        status.className = "status err";
        setTimeout(() => {
            localStorage.setItem("authTab", "login");
            window.location.href = "login.html";
        }, 1000);
        return;
    }

    try {
        selectedJob = await loadSelectedJob(jobId);
        if (!selectedJob) {
            throw new Error("Job not found");
        }

        document.getElementById("apply-job-title").textContent = `${selectedJob.title} at ${selectedJob.company}`;
        document.getElementById("job-meta").textContent = `${selectedJob.location || "Location not specified"} | ${selectedJob.salary || "Salary not specified"}`;

        document.getElementById("apply-full-name").value = currentUser.name || "";
        document.getElementById("apply-email").value = currentUser.email || "";
    } catch (err) {
        status.textContent = err.message;
        status.className = "status err";
    }
}

document.getElementById("applyFormPage").addEventListener("submit", handleSubmit);
init();
</script>
</body>
</html>


